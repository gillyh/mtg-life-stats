<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MTG Life Counter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #1a1f2e;
            --bg-accent: #2a2f3e;
            --text-primary: #e8d5b7;
            --text-secondary: #c4a57b;
            --accent-gold: #d4af37;
            --accent-red: #8b0000;
            --accent-green: #2d5016;
            --shadow-dark: rgba(0, 0, 0, 0.6);
            --glow-gold: rgba(212, 175, 55, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Crimson Pro', serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(139, 0, 0, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 600px;
            margin: 0 auto;
            padding: 8px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            padding: 8px 0;
            animation: fadeInDown 0.6s ease-out;
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-gold);
            text-shadow: 0 0 20px var(--glow-gold), 0 2px 4px var(--shadow-dark);
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 12px 0;
            animation: fadeIn 0.8s ease-out 0.2s both;
            flex-wrap: wrap;
        }

        .view-toggle button {
            font-family: 'Crimson Pro', serif;
            padding: 12px 20px;
            background: var(--bg-accent);
            border: 1px solid var(--accent-gold);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .view-toggle button.active {
            background: var(--accent-gold);
            color: var(--bg-primary);
            box-shadow: 0 0 20px var(--glow-gold);
        }

        .view-toggle button:hover:not(.active) {
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }

        .life-counter-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            animation: fadeIn 0.8s ease-out 0.4s both;
            overflow: hidden;
        }

        .player-count-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .player-count-btn {
            font-family: 'Crimson Pro', serif;
            padding: 10px 20px;
            background: var(--bg-accent);
            border: 2px solid var(--text-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 600;
        }

        .player-count-btn.active {
            background: var(--accent-gold);
            color: var(--bg-primary);
            border-color: var(--accent-gold);
        }

        .player-count-btn:hover:not(.active) {
            background: var(--bg-secondary);
            border-color: var(--accent-gold);
        }

        .players-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Grid layout for 3-4 players */
        .players-container.grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            /* Use fixed viewport-based height for consistency */
            height: calc(100svh - 220px); /* svh = small viewport height (excludes mobile chrome) */
            height: calc(100vh - 220px); /* Fallback for browsers without svh */
            padding: 0;
            width: 100%;
            /* Ensure grid container doesn't overflow */
            overflow: hidden;
            /* Align items to prevent gaps */
            align-items: stretch;
            justify-items: stretch;
        }

        .player-card {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-accent));
            border: 2px solid var(--accent-gold);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px var(--shadow-dark);
            animation: slideInUp 0.6s ease-out;
            display: flex;
            flex-direction: column;
            min-width: 0; /* Prevent overflow */
            min-height: 0; /* Prevent overflow */
            position: relative; /* For tap zones */
        }

        /* Ensure grid cards fit properly with rotations */
        .players-container.grid .player-card {
            /* Cards need to fit within grid cell accounting for rotation */
            width: 100%;
            height: 100%;
            /* Use transform-origin center for proper rotation */
            transform-origin: center center;
        }

        /* Tap zones for life changes */
        .life-tap-zone {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50%;
            z-index: 5;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .life-tap-zone.left {
            left: 0;
            border-radius: 16px 0 0 16px;
        }

        .life-tap-zone.right {
            right: 0;
            border-radius: 0 16px 16px 0;
        }

        .life-tap-zone:active {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Show subtle indication on hover */
        .life-tap-zone.left:hover {
            background: rgba(139, 0, 0, 0.1);
        }

        .life-tap-zone.right:hover {
            background: rgba(45, 80, 22, 0.1);
        }

        /* Smaller padding for grid layout */
        .players-container.grid .player-card {
            padding: 8px;
            overflow: hidden;
            width: 100%;
            height: 100%;
            transform-origin: center center;
            /* Ensure content fits within rotated bounds */
            box-sizing: border-box;
            /* Center the card content */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .players-container.grid .player-header {
            margin-bottom: 3px;
        }

        .players-container.grid .player-name {
            font-size: 0.8rem;
        }

        .players-container.grid .reset-player {
            padding: 2px 4px;
            font-size: 0.6rem;
        }

        .player-card:nth-child(2) {
            animation-delay: 0.1s;
        }

        .player-card:nth-child(3) {
            animation-delay: 0.2s;
        }

        .player-card:nth-child(4) {
            animation-delay: 0.3s;
        }

        .player-card.blank {
            background: transparent;
            border: 2px dashed var(--text-secondary);
            opacity: 0.3;
        }

        /* Rotation classes */
        .player-card.rotate-90 {
            transform: rotate(90deg);
        }

        .player-card.rotate-180 {
            transform: rotate(180deg);
        }

        .player-card.rotate-270 {
            transform: rotate(-90deg);
        }

        /* Scale rotated cards in grid to prevent overlap */
        .players-container.grid .player-card.rotate-90,
        .players-container.grid .player-card.rotate-270 {
            /* When rotated 90Â°, width becomes height, so we need to scale down */
            /* to fit within the grid cell properly */
            transform-origin: center center;
        }

        .players-container.grid .player-card.rotate-90 {
            transform: rotate(90deg) scale(0.85);
        }

        .players-container.grid .player-card.rotate-270 {
            transform: rotate(-90deg) scale(0.85);
        }

        .players-container.grid .player-card.rotate-180 {
            transform: rotate(180deg);
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
            z-index: 10;
        }

        .player-name {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--accent-gold);
            font-weight: 600;
        }

        .reset-player {
            background: var(--accent-red);
            border: none;
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .reset-player:hover {
            background: #a00000;
            transform: scale(1.05);
        }

        .life-display {
            text-align: center;
            font-size: 4.5rem;
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 0 4px 8px var(--shadow-dark);
            margin: 20px 0;
            font-family: 'Cinzel', serif;
            user-select: none;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Smaller life display for 3-4 players */
        .players-container.grid .life-display {
            font-size: 2.6rem;
            margin: 5px 0;
        }

        .life-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            position: relative;
            z-index: 10;
        }

        .players-container.grid .life-controls {
            gap: 3px;
        }

        .additional-counters {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--text-secondary);
            position: relative;
            z-index: 10;
        }

        .players-container.grid .additional-counters {
            margin-top: 6px;
            padding-top: 6px;
        }

        .counter-row {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .players-container.grid .counter-row {
            font-size: 0.7rem;
            margin-bottom: 3px;
            gap: 3px;
        }

        .counter-label {
            flex: 1;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .players-container.grid .counter-label {
            font-size: 0.65rem;
            letter-spacing: 0.3px;
        }

        .counter-value {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            color: var(--accent-gold);
            min-width: 30px;
            text-align: center;
        }

        .counter-btn {
            background: var(--bg-primary);
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .players-container.grid .counter-btn {
            padding: 2px 4px;
            font-size: 0.65rem;
        }

        .counter-btn:hover {
            background: var(--text-secondary);
            color: var(--bg-primary);
        }

        .add-counter-btn {
            width: 100%;
            padding: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 5px;
            font-family: 'Crimson Pro', serif;
            position: relative;
            z-index: 10;
        }

        .players-container.grid .add-counter-btn {
            padding: 5px;
            font-size: 0.7rem;
            margin-top: 4px;
        }

        .add-counter-btn:hover {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        .commander-btn {
            width: 100%;
            padding: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 3px;
            font-family: 'Crimson Pro', serif;
            position: relative;
            z-index: 10;
        }

        .players-container.grid .commander-btn {
            padding: 5px;
            font-size: 0.7rem;
            margin-top: 2px;
        }

        .commander-btn:hover {
            background: var(--accent-red);
            color: var(--text-primary);
        }

        .commander-btn.active {
            background: var(--accent-red);
            color: var(--text-primary);
            box-shadow: 0 0 10px rgba(139, 0, 0, 0.5);
        }

        /* Commander damage mode styling */
        .player-card.commander-dealer {
            cursor: pointer;
            border-color: var(--accent-red);
            box-shadow: 0 0 15px rgba(139, 0, 0, 0.3);
        }

        .player-card.commander-dealer:hover {
            background: linear-gradient(145deg, var(--bg-accent), var(--accent-red));
        }

        .commander-damage-display {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--accent-red);
            color: var(--text-primary);
            padding: 3px 8px;
            border-radius: 6px;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 10;
        }

        .players-container.grid .commander-damage-display {
            font-size: 0.75rem;
            padding: 2px 6px;
        }

        /* Rotation classes for commander damage - rotate opposite of card */
        .commander-damage-display.rotate-0 {
            transform: rotate(0deg);
        }

        .commander-damage-display.rotate-90 {
            transform: rotate(-90deg);
            top: 5px;
            right: 5px;
        }

        .commander-damage-display.rotate-180 {
            transform: rotate(-180deg);
        }

        .commander-damage-display.rotate-270 {
            transform: rotate(90deg);
            top: 5px;
            right: 5px;
        }

        /* Commander damage badges - show per-player */
        .commander-total-badge {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(139, 0, 0, 0.8);
            color: var(--text-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 15;
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            max-width: 80%;
            justify-content: center;
        }

        .players-container.grid .commander-total-badge {
            font-size: 0.55rem;
            padding: 2px 4px;
            max-width: 70%;
        }

        .commander-badge-item {
            background: rgba(139, 0, 0, 0.9);
            padding: 1px 4px;
            border-radius: 3px;
            white-space: nowrap;
        }

        /* Click zones for commander damage */
        .commander-click-zone {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50%;
            z-index: 15;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .commander-click-zone.left {
            left: 0;
        }

        .commander-click-zone.right {
            right: 0;
        }

        .commander-click-zone:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .life-btn {
            background: var(--bg-accent);
            border: 2px solid var(--text-secondary);
            color: var(--text-primary);
            padding: 15px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Cinzel', serif;
            user-select: none;
            touch-action: manipulation;
        }

        /* Smaller buttons for 3-4 players */
        .players-container.grid .life-btn {
            padding: 6px 4px;
            font-size: 0.8rem;
        }

        .life-btn:active {
            transform: scale(0.95);
        }

        .life-btn.increment {
            background: linear-gradient(145deg, var(--accent-green), #3d6620);
            border-color: #4d7630;
        }

        .life-btn.increment:hover {
            box-shadow: 0 0 20px rgba(45, 80, 22, 0.5);
        }

        .life-btn.decrement {
            background: linear-gradient(145deg, var(--accent-red), #a00000);
            border-color: #b00000;
        }

        .life-btn.decrement:hover {
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.5);
        }

        .game-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .game-btn {
            flex: 1;
            padding: 16px;
            background: var(--bg-accent);
            border: 2px solid var(--accent-gold);
            color: var(--text-primary);
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .game-btn:hover {
            background: var(--accent-gold);
            color: var(--bg-primary);
            box-shadow: 0 0 20px var(--glow-gold);
        }

        .stats-view {
            animation: fadeIn 0.6s ease-out;
        }

        .stats-summary {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-accent));
            border: 2px solid var(--accent-gold);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px var(--shadow-dark);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            color: var(--accent-gold);
            text-shadow: 0 2px 4px var(--shadow-dark);
        }

        .game-history {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-accent));
            border: 2px solid var(--accent-gold);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px var(--shadow-dark);
        }

        .history-header {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--accent-gold);
            margin-bottom: 15px;
            text-align: center;
        }

        .game-record {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-gold);
        }

        .game-record.win {
            border-left-color: #4d7630;
        }

        .game-record.loss {
            border-left-color: var(--accent-red);
        }

        .game-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .game-result {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .game-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .delete-game-btn {
            background: var(--accent-red);
            border: none;
            color: var(--text-primary);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .delete-game-btn:hover {
            background: #a00000;
            transform: scale(1.1);
        }

        .delete-game-btn:active {
            transform: scale(0.95);
        }

        .hidden {
            display: none !important;
        }

        .clear-stats-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent-red);
            border: 2px solid #a00000;
            color: var(--text-primary);
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .clear-stats-btn:hover {
            background: #a00000;
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.5);
        }

        /* Decks View Styles */
        .decks-view {
            animation: fadeIn 0.6s ease-out;
        }

        .add-deck-section {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-accent));
            border: 2px solid var(--accent-gold);
            border-radius: 16px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 8px 32px var(--shadow-dark);
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--accent-gold);
            margin-bottom: 15px;
            text-align: center;
        }

        .deck-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-input {
            background: var(--bg-primary);
            border: 2px solid var(--text-secondary);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 10px var(--glow-gold);
        }

        .color-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .color-option {
            width: 100%;
            aspect-ratio: 1;
            border: 3px solid transparent;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px var(--glow-gold);
        }

        .color-option.white { background: #f0e68c; }
        .color-option.blue { background: #4169e1; }
        .color-option.black { background: #2f2f2f; }
        .color-option.red { background: #dc143c; }
        .color-option.green { background: #228b22; }

        .add-deck-btn {
            padding: 14px;
            background: var(--accent-gold);
            border: none;
            color: var(--bg-primary);
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .add-deck-btn:hover {
            background: var(--text-primary);
            box-shadow: 0 0 20px var(--glow-gold);
            transform: translateY(-2px);
        }

        .decks-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .deck-card {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-accent));
            border: 2px solid var(--accent-gold);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px var(--shadow-dark);
            transition: all 0.3s ease;
        }

        .deck-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px var(--shadow-dark);
        }

        .deck-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .deck-name {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            color: var(--accent-gold);
            font-weight: 600;
        }

        .deck-colors {
            display: flex;
            gap: 5px;
        }

        .deck-color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--text-secondary);
        }

        .deck-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .deck-stat {
            text-align: center;
        }

        .deck-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .deck-stat-value {
            font-size: 1.5rem;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 5px;
        }

        .deck-actions {
            display: flex;
            gap: 10px;
        }

        .deck-btn {
            flex: 1;
            padding: 10px;
            background: var(--bg-accent);
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            font-family: 'Crimson Pro', serif;
            transition: all 0.3s ease;
        }

        .deck-btn:hover {
            background: var(--bg-primary);
            border-color: var(--accent-gold);
        }

        .deck-btn.delete {
            background: var(--accent-red);
            border-color: #a00000;
        }

        .deck-btn.delete:hover {
            background: #a00000;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-accent));
            border: 2px solid var(--accent-gold);
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 16px 64px var(--shadow-dark);
            animation: slideInUp 0.4s ease-out;
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--accent-gold);
            margin-bottom: 20px;
            text-align: center;
        }

        .deck-select {
            background: var(--bg-primary);
            border: 2px solid var(--text-secondary);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .deck-select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 10px var(--glow-gold);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .modal-btn.confirm {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        .modal-btn.confirm:hover {
            background: var(--text-primary);
            box-shadow: 0 0 20px var(--glow-gold);
        }

        .modal-btn.cancel {
            background: var(--bg-accent);
            color: var(--text-primary);
            border: 2px solid var(--text-secondary);
        }

        .modal-btn.cancel:hover {
            background: var(--bg-primary);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .counter-type-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .counter-type-option {
            padding: 12px;
            background: var(--bg-primary);
            border: 2px solid var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
        }

        .counter-type-option:hover {
            border-color: var(--accent-gold);
            background: var(--bg-accent);
        }

        .counter-type-option.selected {
            border-color: var(--accent-gold);
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        /* Player name editing */
        .player-name-editable {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .player-name-editable:hover {
            background: rgba(212, 175, 55, 0.2);
        }

        .player-name-input {
            background: var(--bg-primary);
            border: 2px solid var(--accent-gold);
            border-radius: 4px;
            padding: 2px 4px;
            color: var(--text-primary);
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            font-weight: 600;
            width: 120px;
            text-align: left;
        }

        .players-container.grid .player-name-input {
            font-size: 0.8rem;
            width: 80px;
        }

        .player-name-input:focus {
            outline: none;
            box-shadow: 0 0 10px var(--glow-gold);
        }

        /* 1P Commander damage modal */
        .commander-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .commander-option {
            background: var(--bg-primary);
            border: 2px solid var(--text-secondary);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .commander-name {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--accent-gold);
        }

        .commander-damage-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .commander-damage-value {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            color: var(--text-primary);
            min-width: 40px;
            text-align: center;
        }

        .commander-damage-btn {
            background: var(--bg-accent);
            border: 2px solid var(--text-secondary);
            color: var(--text-primary);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Cinzel', serif;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .commander-damage-btn.increment {
            background: linear-gradient(145deg, var(--accent-green), #3d6620);
            border-color: #4d7630;
        }

        .commander-damage-btn.decrement {
            background: linear-gradient(145deg, var(--accent-red), #a00000);
            border-color: #b00000;
        }

        .commander-damage-btn:active {
            transform: scale(0.95);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }

            .container {
                padding: 8px;
            }
            
            header {
                padding: 8px 0;
            }
            
            .life-display {
                font-size: 3rem;
            }
            
            .players-container.grid {
                gap: 6px;
                padding: 0;
                /* More aggressive height control for mobile */
                height: calc(100svh - 220px);
                height: calc(100vh - 220px);
                max-height: none;
                min-height: 0;
            }

            .players-container.grid .player-card {
                padding: 6px;
                border-radius: 10px;
            }

            .players-container.grid .life-display {
                font-size: 1.8rem;
                margin: 3px 0;
            }
            
            .life-btn {
                padding: 15px;
                font-size: 1.2rem;
            }

            .players-container.grid .life-btn {
                padding: 5px 3px;
                font-size: 0.75rem;
                border-radius: 6px;
            }

            .players-container.grid .life-controls {
                gap: 2px;
            }

            /* More aggressive scaling for rotated cards on mobile */
            .players-container.grid .player-card.rotate-90 {
                transform: rotate(90deg) scale(0.75);
            }

            .players-container.grid .player-card.rotate-270 {
                transform: rotate(-90deg) scale(0.75);
            }

            .players-container.grid .player-name {
                font-size: 0.75rem;
            }

            .players-container.grid .reset-player {
                padding: 2px 4px;
                font-size: 0.6rem;
            }

            .players-container.grid .player-header {
                margin-bottom: 2px;
            }

            .players-container.grid .additional-counters {
                margin-top: 4px;
                padding-top: 4px;
            }

            .players-container.grid .add-counter-btn {
                padding: 3px;
                font-size: 0.55rem;
                margin-top: 3px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>MTG LIFE</h1>
            <div class="subtitle">Counter & Statistics</div>
        </header>

        <div class="view-toggle">
            <button id="counterViewBtn" class="active">Life Counter</button>
            <button id="decksViewBtn">Decks</button>
            <button id="statsViewBtn">Statistics</button>
        </div>

        <!-- Life Counter View -->
        <div id="lifeCounterView" class="life-counter-view">
            <div class="player-count-selector">
                <button class="player-count-btn" data-count="1">1P</button>
                <button class="player-count-btn" data-count="2">2P</button>
                <button class="player-count-btn" data-count="3">3P</button>
                <button class="player-count-btn active" data-count="4">4P</button>
            </div>

            <div class="players-container grid" id="playersContainer">
                <!-- Player 1 -->
                <div class="player-card" id="player1Card">
                    <div class="life-tap-zone left" onclick="changeLife(0, -1)"></div>
                    <div class="life-tap-zone right" onclick="changeLife(0, 1)"></div>
                    <div class="player-header">
                        <span class="player-name">Player 1</span>
                        <button class="reset-player" onclick="resetPlayer(0)">Reset</button>
                    </div>
                    <div class="life-display" id="player1Life">40</div>
                    <div class="life-controls">
                        <button class="life-btn decrement" onclick="changeLife(0, -5)">-5</button>
                        <button class="life-btn increment" onclick="changeLife(0, 5)">+5</button>
                    </div>
                    <div class="additional-counters" id="player1Counters"></div>
                    <button class="add-counter-btn" onclick="openCounterModal(0)">+ Counter</button>
                    <button class="commander-btn" onclick="openCommanderMode(0)">Commander</button>
                </div>

                <!-- Player 2 -->
                <div class="player-card" id="player2Card">
                    <div class="life-tap-zone left" onclick="changeLife(1, -1)"></div>
                    <div class="life-tap-zone right" onclick="changeLife(1, 1)"></div>
                    <div class="player-header">
                        <span class="player-name">Player 2</span>
                        <button class="reset-player" onclick="resetPlayer(1)">Reset</button>
                    </div>
                    <div class="life-display" id="player2Life">40</div>
                    <div class="life-controls">
                        <button class="life-btn decrement" onclick="changeLife(1, -5)">-5</button>
                        <button class="life-btn increment" onclick="changeLife(1, 5)">+5</button>
                    </div>
                    <div class="additional-counters" id="player2Counters"></div>
                    <button class="add-counter-btn" onclick="openCounterModal(1)">+ Counter</button>
                    <button class="commander-btn" onclick="openCommanderMode(1)">Commander</button>
                </div>

                <!-- Player 3 -->
                <div class="player-card" id="player3Card">
                    <div class="life-tap-zone left" onclick="changeLife(2, -1)"></div>
                    <div class="life-tap-zone right" onclick="changeLife(2, 1)"></div>
                    <div class="player-header">
                        <span class="player-name">Player 3</span>
                        <button class="reset-player" onclick="resetPlayer(2)">Reset</button>
                    </div>
                    <div class="life-display" id="player3Life">40</div>
                    <div class="life-controls">
                        <button class="life-btn decrement" onclick="changeLife(2, -5)">-5</button>
                        <button class="life-btn increment" onclick="changeLife(2, 5)">+5</button>
                    </div>
                    <div class="additional-counters" id="player3Counters"></div>
                    <button class="add-counter-btn" onclick="openCounterModal(2)">+ Counter</button>
                    <button class="commander-btn" onclick="openCommanderMode(2)">Commander</button>
                </div>

                <!-- Player 4 / Blank -->
                <div class="player-card blank" id="player4Card">
                </div>
            </div>

            <div class="game-controls">
                <button class="game-btn" onclick="endGame('win')">Win</button>
                <button class="game-btn" onclick="endGame('loss')">Lose</button>
                <button class="game-btn" onclick="resetGame()">New Game</button>
            </div>
        </div>

        <!-- Decks View -->
        <div id="decksView" class="decks-view hidden">
            <div id="decksList" class="decks-list"></div>

            <div class="add-deck-section">
                <div class="section-title">Create New Deck</div>
                <form class="deck-form" onsubmit="addDeck(event)">
                    <div class="form-group">
                        <label class="form-label">Deck Name</label>
                        <input type="text" id="deckName" class="form-input" placeholder="Enter deck name..." required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Colors</label>
                        <div class="color-selector" id="colorSelector">
                            <div class="color-option white" data-color="white" onclick="toggleColor('white')"></div>
                            <div class="color-option blue" data-color="blue" onclick="toggleColor('blue')"></div>
                            <div class="color-option black" data-color="black" onclick="toggleColor('black')"></div>
                            <div class="color-option red" data-color="red" onclick="toggleColor('red')"></div>
                            <div class="color-option green" data-color="green" onclick="toggleColor('green')"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes (Optional)</label>
                        <input type="text" id="deckNotes" class="form-input" placeholder="Commander, strategy, etc...">
                    </div>
                    <button type="submit" class="add-deck-btn">Add Deck</button>
                </form>
            </div>
        </div>

        <!-- Statistics View -->
        <div id="statsView" class="stats-view hidden">
            <div class="stats-summary">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total Games</div>
                        <div class="stat-value" id="totalGames">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Wins</div>
                        <div class="stat-value" id="totalWins">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Losses</div>
                        <div class="stat-value" id="totalLosses">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-value" id="winRate">0%</div>
                    </div>
                </div>
            </div>

            <div class="game-history">
                <div class="history-header">Recent Games</div>
                <div id="gameHistoryList"></div>
            </div>

            <button class="clear-stats-btn" id="clearStatsBtn">Clear All Statistics</button>
        </div>
    </div>

    <!-- Deck Selection Modal -->
    <div id="deckModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Select Deck</div>
            <select id="deckSelect" class="deck-select">
                <option value="">No deck (just tracking game)</option>
            </select>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeDeckModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmGameEnd()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Add Counter Modal -->
    <div id="counterModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Add Counter</div>
            <div class="counter-type-list">
                <div class="counter-type-option" onclick="selectCounterType('Poison')">Poison</div>
                <div class="counter-type-option" onclick="selectCounterType('Experience')">Experience</div>
                <div class="counter-type-option" onclick="selectCounterType('Energy')">Energy</div>
                <div class="counter-type-option" onclick="selectCounterType('Custom')">Custom</div>
            </div>
            <input type="text" id="customCounterName" class="form-input" placeholder="Custom counter name..." style="display: none; margin-bottom: 15px;">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeCounterModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmAddCounter()">Add</button>
            </div>
        </div>
    </div>

    <!-- 1P Commander Damage Modal -->
    <div id="commanderDamageModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Commander Damage</div>
            <div class="commander-list" id="commanderList">
                <!-- Dynamically populated -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeCommanderDamageModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            playerCount: 4,
            players: [40, 40, 40, 40],
            playerNames: ['Player 1', 'Player 2', 'Player 3', 'Player 4'],
            counters: [[], [], [], []], // Additional counters for each player
            commanderDamage: [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]], // [receiver][dealer]
            gameStartTime: Date.now()
        };

        // Track pending game result
        let pendingGameResult = null;

        // Selected colors for new deck
        let selectedColors = [];

        // Counter modal state
        let currentPlayerForCounter = null;
        let selectedCounterType = null;

        // Commander damage tracking state
        let commanderDamageMode = false;
        let commanderDamageReceiver = null;

        // Initialize from localStorage
        function initApp() {
            const savedState = localStorage.getItem('mtgGameState');
            if (savedState) {
                gameState = JSON.parse(savedState);
                // Ensure counters array exists for backwards compatibility
                if (!gameState.counters) {
                    gameState.counters = Array(gameState.players.length).fill(null).map(() => []);
                }
                // Ensure commander damage array exists
                if (!gameState.commanderDamage) {
                    gameState.commanderDamage = Array(gameState.players.length).fill(null).map(() => Array(gameState.players.length).fill(0));
                }
                // Ensure player names array exists
                if (!gameState.playerNames) {
                    gameState.playerNames = Array(gameState.players.length).fill(null).map((_, i) => `Player ${i+1}`);
                }
                updatePlayerCountUI();
                updateAllLifeDisplays();
                renderAllCounters();
                renderAllCommanderTotals();
                updateAllPlayerNames();
            }
            updateStats();
            loadDecks();
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('mtgGameState', JSON.stringify(gameState));
        }

        // Set player count
        function setPlayerCount(count) {
            const oldCount = gameState.playerCount;
            gameState.playerCount = count;
            
            // Default life totals: 20 for 2 players, 40 for 1/3/4 players
            const defaultLife = count === 2 ? 20 : 40;
            
            // If switching player counts, reset all life totals to default
            if (oldCount !== count) {
                const oldNames = [...gameState.playerNames];
                gameState.players = [];
                gameState.counters = [];
                gameState.playerNames = [];
                for (let i = 0; i < count; i++) {
                    gameState.players.push(defaultLife);
                    gameState.counters.push([]);
                    // Preserve old names if they exist
                    gameState.playerNames.push(oldNames[i] || `Player ${i+1}`);
                }
                // Reset commander damage tracking
                gameState.commanderDamage = Array(count).fill(null).map(() => Array(count).fill(0));
            }
            
            updatePlayerCountUI();
            saveState();
        }

        // Update player count UI
        function updatePlayerCountUI() {
            const container = document.getElementById('playersContainer');
            const player1 = document.getElementById('player1Card');
            const player2 = document.getElementById('player2Card');
            const player3 = document.getElementById('player3Card');
            const player4 = document.getElementById('player4Card');
            
            // Update active button
            document.querySelectorAll('.player-count-btn').forEach(btn => {
                if (parseInt(btn.getAttribute('data-count')) === gameState.playerCount) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Remove all rotation classes first
            [player1, player2, player3, player4].forEach(card => {
                card.classList.remove('rotate-90', 'rotate-180', 'rotate-270');
            });
            
            if (gameState.playerCount === 1) {
                // Single player - no rotation, vertical layout
                container.classList.remove('grid');
                player1.classList.remove('hidden');
                player2.classList.add('hidden');
                player3.classList.add('hidden');
                player4.classList.add('hidden');
            } else if (gameState.playerCount === 2) {
                // Stack layout for 2 players
                // Top player: no rotation, Bottom player: 180 degrees
                container.classList.remove('grid');
                player1.classList.remove('hidden');
                player2.classList.remove('hidden');
                player3.classList.add('hidden');
                player4.classList.add('hidden');
                
                player1.classList.add('rotate-180'); // Bottom player rotated
            } else if (gameState.playerCount === 3) {
                // Grid with 3 players, one blank
                // Top-left: 90Â°, Top-right: -90Â°, Bottom-left: 90Â°, Bottom-right: blank
                container.classList.add('grid');
                player1.classList.remove('hidden');
                player2.classList.remove('hidden');
                player3.classList.remove('hidden');
                player4.classList.remove('hidden');
                player4.classList.add('blank');
                player4.innerHTML = ''; // Clear blank card
                
                player1.classList.add('rotate-90');  // Top-left
                player2.classList.add('rotate-270'); // Top-right
                player3.classList.add('rotate-90');  // Bottom-left
            } else if (gameState.playerCount === 4) {
                // Grid with 4 players
                // Top-left: 90Â°, Top-right: -90Â°, Bottom-left: 90Â°, Bottom-right: -90Â°
                container.classList.add('grid');
                player1.classList.remove('hidden');
                player2.classList.remove('hidden');
                player3.classList.remove('hidden');
                player4.classList.remove('hidden');
                player4.classList.remove('blank');
                
                // Rebuild player 4 if it was blank
                if (!document.getElementById('player4Life')) {
                    player4.innerHTML = `
                        <div class="life-tap-zone left" onclick="changeLife(3, -1)"></div>
                        <div class="life-tap-zone right" onclick="changeLife(3, 1)"></div>
                        <div class="player-header">
                            <span class="player-name">Player 4</span>
                            <button class="reset-player" onclick="resetPlayer(3)">Reset</button>
                        </div>
                        <div class="life-display" id="player4Life">40</div>
                        <div class="life-controls">
                            <button class="life-btn decrement" onclick="changeLife(3, -5)">-5</button>
                            <button class="life-btn increment" onclick="changeLife(3, 5)">+5</button>
                        </div>
                        <div class="additional-counters" id="player4Counters"></div>
                        <button class="add-counter-btn" onclick="openCounterModal(3)">+ Counter</button>
                        <button class="commander-btn" onclick="openCommanderMode(3)">Commander</button>
                    `;
                    updatePlayer4Name();
                }
                
                player1.classList.add('rotate-90');  // Top-left
                player2.classList.add('rotate-270'); // Top-right
                player3.classList.add('rotate-90');  // Bottom-left
                player4.classList.add('rotate-270'); // Bottom-right
            }
            
            updateAllLifeDisplays();
            renderAllCounters();
            updateAllPlayerNames();
        }

        // Update all life displays
        function updateAllLifeDisplays() {
            for (let i = 0; i < gameState.players.length; i++) {
                const lifeElement = document.getElementById(`player${i+1}Life`);
                if (lifeElement) {
                    lifeElement.textContent = gameState.players[i];
                }
            }
        }

        // Change life total
        function changeLife(playerIndex, amount) {
            gameState.players[playerIndex] += amount;
            document.getElementById(`player${playerIndex+1}Life`).textContent = gameState.players[playerIndex];
            saveState();
        }

        // Reset individual player
        function resetPlayer(playerIndex) {
            const defaultLife = gameState.playerCount === 2 ? 20 : 40;
            gameState.players[playerIndex] = defaultLife;
            gameState.counters[playerIndex] = []; // Clear all counters
            // Clear commander damage for this player
            for (let i = 0; i < gameState.playerCount; i++) {
                gameState.commanderDamage[playerIndex][i] = 0;
                gameState.commanderDamage[i][playerIndex] = 0;
            }
            document.getElementById(`player${playerIndex+1}Life`).textContent = defaultLife;
            renderPlayerCounters(playerIndex);
            if (commanderDamageMode) {
                renderCommanderDamage();
            }
            renderAllCommanderTotals();
            saveState();
        }

        // Reset entire game
        function resetGame() {
            const defaultLife = gameState.playerCount === 2 ? 20 : 40;
            gameState.players = gameState.players.map(() => defaultLife);
            gameState.counters = gameState.counters.map(() => []); // Clear all counters
            gameState.commanderDamage = Array(gameState.playerCount).fill(null).map(() => Array(gameState.playerCount).fill(0));
            gameState.gameStartTime = Date.now();
            closeCommanderMode(); // Exit commander mode
            updateAllLifeDisplays();
            renderAllCounters();
            renderAllCommanderTotals();
            saveState();
        }

        // Edit player name
        function editPlayerName(playerIndex) {
            const playerNameElement = document.querySelector(`#player${playerIndex+1}Card .player-name`);
            const currentName = gameState.playerNames[playerIndex];
            
            // Create input element
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'player-name-input';
            input.maxLength = 20;
            
            // Replace name with input
            playerNameElement.replaceWith(input);
            input.focus();
            input.select();
            
            // Save on blur or enter
            const saveName = () => {
                const newName = input.value.trim() || `Player ${playerIndex+1}`;
                gameState.playerNames[playerIndex] = newName;
                
                // Create new span element
                const span = document.createElement('span');
                span.className = 'player-name player-name-editable';
                span.textContent = newName;
                span.onclick = () => editPlayerName(playerIndex);
                
                input.replaceWith(span);
                saveState();
            };
            
            input.addEventListener('blur', saveName);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            });
        }

        // Update all player names
        function updateAllPlayerNames() {
            for (let i = 0; i < gameState.playerCount; i++) {
                const playerNameElement = document.querySelector(`#player${i+1}Card .player-name`);
                if (playerNameElement && !playerNameElement.classList.contains('player-name-input')) {
                    playerNameElement.textContent = gameState.playerNames[i];
                    playerNameElement.classList.add('player-name-editable');
                    playerNameElement.onclick = () => editPlayerName(i);
                }
            }
        }

        // Update player name in dynamic player 4 card
        function updatePlayer4Name() {
            const player4NameElement = document.querySelector('#player4Card .player-name');
            if (player4NameElement) {
                player4NameElement.textContent = gameState.playerNames[3];
                player4NameElement.classList.add('player-name-editable');
                player4NameElement.onclick = () => editPlayerName(3);
            }
        }

        // End game - show deck selection modal
        function endGame(result) {
            pendingGameResult = result;
            populateDeckSelect();
            document.getElementById('deckModal').classList.add('active');
        }

        // Populate deck select dropdown
        function populateDeckSelect() {
            const decks = JSON.parse(localStorage.getItem('mtgDecks') || '[]');
            const select = document.getElementById('deckSelect');
            
            select.innerHTML = '<option value="">No deck (just tracking game)</option>';
            
            decks.forEach(deck => {
                const option = document.createElement('option');
                option.value = deck.id;
                option.textContent = deck.name;
                select.appendChild(option);
            });
        }

        // Close deck modal
        function closeDeckModal() {
            document.getElementById('deckModal').classList.remove('active');
            pendingGameResult = null;
        }

        // Confirm game end with selected deck
        function confirmGameEnd() {
            const selectedDeckId = document.getElementById('deckSelect').value;
            
            // Save the result before we clear it
            const gameResult = pendingGameResult;
            
            const games = JSON.parse(localStorage.getItem('mtgGameHistory') || '[]');
            
            const gameRecord = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                result: gameResult,
                playerCount: gameState.playerCount,
                finalLives: [...gameState.players],
                duration: Math.floor((Date.now() - gameState.gameStartTime) / 1000 / 60), // minutes
                deckId: selectedDeckId || null
            };
            
            games.unshift(gameRecord);
            
            // Keep only last 100 games
            if (games.length > 100) {
                games.pop();
            }
            
            localStorage.setItem('mtgGameHistory', JSON.stringify(games));
            
            // Update deck stats if a deck was selected
            if (selectedDeckId) {
                updateDeckStats(selectedDeckId, gameResult);
            }
            
            // Close modal
            closeDeckModal();
            
            // Reset for new game
            resetGame();
            
            // Show confirmation
            alert(`Game recorded as ${gameResult.toUpperCase()}!`);
            
            // Update stats if on that view
            if (!document.getElementById('statsView').classList.contains('hidden')) {
                updateStats();
            }
        }

        // Update deck statistics
        function updateDeckStats(deckId, result) {
            const decks = JSON.parse(localStorage.getItem('mtgDecks') || '[]');
            const deck = decks.find(d => d.id === deckId);
            
            if (deck) {
                deck.gamesPlayed = (deck.gamesPlayed || 0) + 1;
                if (result === 'win') {
                    deck.wins = (deck.wins || 0) + 1;
                } else {
                    deck.losses = (deck.losses || 0) + 1;
                }
                
                localStorage.setItem('mtgDecks', JSON.stringify(decks));
                
                // Reload decks view if visible
                if (!document.getElementById('decksView').classList.contains('hidden')) {
                    loadDecks();
                }
            }
        }

        // Update statistics display
        function updateStats() {
            const games = JSON.parse(localStorage.getItem('mtgGameHistory') || '[]');
            
            const totalGames = games.length;
            const wins = games.filter(g => g.result === 'win').length;
            const losses = games.filter(g => g.result === 'loss').length;
            const winRate = totalGames > 0 ? Math.round((wins / totalGames) * 100) : 0;
            
            document.getElementById('totalGames').textContent = totalGames;
            document.getElementById('totalWins').textContent = wins;
            document.getElementById('totalLosses').textContent = losses;
            document.getElementById('winRate').textContent = winRate + '%';
            
            // Display game history
            const historyList = document.getElementById('gameHistoryList');
            if (games.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No games recorded yet</div>';
            } else {
                const decks = JSON.parse(localStorage.getItem('mtgDecks') || '[]');
                
                historyList.innerHTML = games.slice(0, 10).map((game, index) => {
                    const date = new Date(game.date);
                    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    let deckName = 'No deck';
                    if (game.deckId) {
                        const deck = decks.find(d => d.id === game.deckId);
                        deckName = deck ? deck.name : 'Deleted deck';
                    }
                    
                    // Format final lives display
                    const livesDisplay = game.finalLives ? 
                        game.finalLives.map((life, i) => `P${i+1}:${life}`).join(' | ') :
                        `P1: ${game.player1FinalLife || 0} | P2: ${game.player2FinalLife || 0}`;
                    
                    // Find the actual index in the full games array (not just the slice)
                    const actualIndex = games.indexOf(game);
                    
                    return `
                        <div class="game-record ${game.result}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div class="game-date">${dateStr}</div>
                                    <div class="game-result">${game.result.toUpperCase()} - ${deckName}</div>
                                    <div class="game-details">
                                        ${livesDisplay} | ${game.duration} min
                                    </div>
                                </div>
                                <button class="delete-game-btn" data-game-index="${actualIndex}" title="Delete this game">Ã</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add click handlers to delete buttons
                document.querySelectorAll('.delete-game-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const gameIndex = parseInt(this.getAttribute('data-game-index'));
                        deleteGame(gameIndex);
                    });
                });
            }
        }

        // Clear all statistics
        function clearAllStats() {
            if (confirm('Are you sure you want to clear all game statistics? This cannot be undone.')) {
                localStorage.removeItem('mtgGameHistory');
                
                // Reset deck stats
                const decks = JSON.parse(localStorage.getItem('mtgDecks') || '[]');
                decks.forEach(deck => {
                    deck.gamesPlayed = 0;
                    deck.wins = 0;
                    deck.losses = 0;
                });
                localStorage.setItem('mtgDecks', JSON.stringify(decks));
                
                updateStats();
                loadDecks();
                alert('All statistics cleared!');
            }
        }

        // Delete individual game
        function deleteGame(gameIndex) {
            if (!confirm('Delete this game record?')) {
                return;
            }
            
            let games = JSON.parse(localStorage.getItem('mtgGameHistory') || '[]');
            
            // Check if the game index is valid
            if (gameIndex < 0 || gameIndex >= games.length) {
                alert('Game not found.');
                return;
            }
            
            const game = games[gameIndex];
            
            // Update deck stats if this game had a deck
            if (game && game.deckId) {
                let decks = JSON.parse(localStorage.getItem('mtgDecks') || '[]');
                const deck = decks.find(d => d.id === game.deckId);
                
                if (deck) {
                    deck.gamesPlayed = Math.max(0, deck.gamesPlayed - 1);
                    if (game.result === 'win') {
                        deck.wins = Math.max(0, deck.wins - 1);
                    } else if (game.result === 'loss') {
                        deck.losses = Math.max(0, deck.losses - 1);
                    }
                    localStorage.setItem('mtgDecks', JSON.stringify(decks));
                }
            }
            
            // Remove the game
            games.splice(gameIndex, 1);
            localStorage.setItem('mtgGameHistory', JSON.stringify(games));
            
            // Refresh displays
            updateStats();
            loadDecks();
        }

        // === COMMANDER DAMAGE ===

        // Open commander damage mode
        function openCommanderMode(receiverIndex) {
            // Special case: 1P mode opens modal instead
            if (gameState.playerCount === 1) {
                openCommanderDamageModal();
                return;
            }
            
            if (commanderDamageMode && commanderDamageReceiver === receiverIndex) {
                // Close commander mode if clicking same button
                closeCommanderMode();
                return;
            }

            commanderDamageMode = true;
            commanderDamageReceiver = receiverIndex;

            // Highlight the commander button
            document.querySelectorAll('.commander-btn').forEach((btn, idx) => {
                if (idx === receiverIndex) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Get receiver's card rotation to determine their perspective
            const receiverCard = document.getElementById(`player${receiverIndex+1}Card`);
            let receiverRotation = 0;
            if (receiverCard.classList.contains('rotate-90')) receiverRotation = 90;
            else if (receiverCard.classList.contains('rotate-180')) receiverRotation = 180;
            else if (receiverCard.classList.contains('rotate-270')) receiverRotation = 270;

            // Make all other player cards clickable for commander damage
            document.querySelectorAll('.player-card').forEach((card, idx) => {
                if (idx !== receiverIndex && idx < gameState.playerCount) {
                    card.classList.add('commander-dealer');
                    
                    // Remove old click zones if they exist
                    card.querySelectorAll('.commander-click-zone').forEach(zone => zone.remove());
                    
                    // Get dealer's rotation
                    let dealerRotation = 0;
                    if (card.classList.contains('rotate-90')) dealerRotation = 90;
                    else if (card.classList.contains('rotate-180')) dealerRotation = 180;
                    else if (card.classList.contains('rotate-270')) dealerRotation = 270;
                    
                    // Calculate relative rotation from receiver's perspective
                    let relativeRotation = (dealerRotation - receiverRotation + 360) % 360;
                    
                    // Determine which physical side corresponds to "right" from receiver's perspective
                    // relativeRotation 0 = dealer is same orientation as receiver
                    // relativeRotation 90 = dealer is 90Â° clockwise from receiver
                    // relativeRotation 180 = dealer is opposite from receiver  
                    // relativeRotation 270 = dealer is 90Â° counter-clockwise from receiver
                    
                    let incrementSide, decrementSide;
                    
                    if (relativeRotation === 0) {
                        // Same orientation: right is right, left is left
                        incrementSide = 'right';
                        decrementSide = 'left';
                    } else if (relativeRotation === 90) {
                        // Dealer rotated 90Â° clockwise: right from receiver = bottom of dealer = left
                        incrementSide = 'left';
                        decrementSide = 'right';
                    } else if (relativeRotation === 180) {
                        // Opposite orientation: right from receiver = left of dealer
                        incrementSide = 'left';
                        decrementSide = 'right';
                    } else { // 270
                        // Dealer rotated 90Â° counter-clockwise: right from receiver = top of dealer = right
                        incrementSide = 'right';
                        decrementSide = 'left';
                    }
                    
                    // Create click zones
                    const leftZone = document.createElement('div');
                    leftZone.className = 'commander-click-zone left';
                    leftZone.onclick = (e) => {
                        e.stopPropagation();
                        if (decrementSide === 'left') {
                            decrementCommanderDamage(receiverIndex, idx);
                        } else {
                            incrementCommanderDamage(receiverIndex, idx);
                        }
                    };
                    
                    const rightZone = document.createElement('div');
                    rightZone.className = 'commander-click-zone right';
                    rightZone.onclick = (e) => {
                        e.stopPropagation();
                        if (incrementSide === 'right') {
                            incrementCommanderDamage(receiverIndex, idx);
                        } else {
                            decrementCommanderDamage(receiverIndex, idx);
                        }
                    };
                    
                    card.appendChild(leftZone);
                    card.appendChild(rightZone);
                } else {
                    card.classList.remove('commander-dealer');
                    card.querySelectorAll('.commander-click-zone').forEach(zone => zone.remove());
                }
            });

            renderCommanderDamage();
        }

        // Close commander damage mode
        function closeCommanderMode() {
            commanderDamageMode = false;
            commanderDamageReceiver = null;

            // Remove all highlights and click handlers
            document.querySelectorAll('.commander-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('commander-dealer');
                card.querySelectorAll('.commander-click-zone').forEach(zone => zone.remove());
            });

            renderCommanderDamage();
            renderAllCommanderTotals();
        }

        // Open 1P commander damage modal
        function openCommanderDamageModal() {
            const modal = document.getElementById('commanderDamageModal');
            const commanderList = document.getElementById('commanderList');
            
            // Build list of commanders (players 2-4)
            commanderList.innerHTML = '';
            for (let i = 1; i < 4; i++) {
                const damage = gameState.commanderDamage[0][i] || 0;
                const commanderName = gameState.playerNames[i] || `Player ${i+1}`;
                
                const commanderOption = document.createElement('div');
                commanderOption.className = 'commander-option';
                commanderOption.innerHTML = `
                    <div class="commander-name">${commanderName}</div>
                    <div class="commander-damage-controls">
                        <button class="commander-damage-btn decrement" onclick="adjust1PCommanderDamage(${i}, -1)">-</button>
                        <div class="commander-damage-value" id="commander-damage-${i}">${damage}</div>
                        <button class="commander-damage-btn increment" onclick="adjust1PCommanderDamage(${i}, 1)">+</button>
                    </div>
                `;
                commanderList.appendChild(commanderOption);
            }
            
            modal.classList.add('active');
        }

        // Close 1P commander damage modal
        function closeCommanderDamageModal() {
            document.getElementById('commanderDamageModal').classList.remove('active');
            renderAllCommanderTotals();
        }

        // Adjust commander damage in 1P mode
        function adjust1PCommanderDamage(dealerIndex, amount) {
            gameState.commanderDamage[0][dealerIndex] = Math.max(0, (gameState.commanderDamage[0][dealerIndex] || 0) + amount);
            document.getElementById(`commander-damage-${dealerIndex}`).textContent = gameState.commanderDamage[0][dealerIndex];
            saveState();
        }

        // Increment commander damage (click to add, long press to subtract could be added)
        function incrementCommanderDamage(receiver, dealer) {
            if (!commanderDamageMode || commanderDamageReceiver !== receiver) return;
            
            // Increment damage
            gameState.commanderDamage[receiver][dealer] = (gameState.commanderDamage[receiver][dealer] || 0) + 1;
            
            renderCommanderDamage();
            renderAllCommanderTotals();
            saveState();
        }

        // Decrement commander damage
        function decrementCommanderDamage(receiver, dealer) {
            if (gameState.commanderDamage[receiver][dealer] > 0) {
                gameState.commanderDamage[receiver][dealer]--;
                renderCommanderDamage();
                renderAllCommanderTotals();
                saveState();
            }
        }

        // Render commander damage displays
        function renderCommanderDamage() {
            // Remove all existing commander damage displays (but not totals)
            document.querySelectorAll('.commander-damage-display').forEach(el => el.remove());

            if (!commanderDamageMode) return;

            // Get receiver's card rotation
            const receiverCard = document.getElementById(`player${commanderDamageReceiver+1}Card`);
            let receiverRotation = 0;
            if (receiverCard.classList.contains('rotate-90')) receiverRotation = 90;
            else if (receiverCard.classList.contains('rotate-180')) receiverRotation = 180;
            else if (receiverCard.classList.contains('rotate-270')) receiverRotation = 270;

            // Show commander damage from each dealer to the receiver
            for (let dealer = 0; dealer < gameState.playerCount; dealer++) {
                if (dealer === commanderDamageReceiver) continue;

                const damage = gameState.commanderDamage[commanderDamageReceiver][dealer] || 0;
                
                const dealerCard = document.getElementById(`player${dealer+1}Card`);
                if (dealerCard) {
                    // Get dealer's rotation
                    let dealerRotation = 0;
                    if (dealerCard.classList.contains('rotate-90')) dealerRotation = 90;
                    else if (dealerCard.classList.contains('rotate-180')) dealerRotation = 180;
                    else if (dealerCard.classList.contains('rotate-270')) dealerRotation = 270;

                    // Calculate rotation to face receiver
                    // We want to rotate relative to the receiver's perspective
                    let displayRotation = receiverRotation - dealerRotation;
                    if (displayRotation < 0) displayRotation += 360;
                    
                    const display = document.createElement('div');
                    display.className = `commander-damage-display rotate-${displayRotation}`;
                    display.textContent = damage;
                    
                    dealerCard.style.position = 'relative';
                    dealerCard.appendChild(display);
                }
            }
        }

        // Render commander damage badges for all players (per-player breakdown)
        function renderAllCommanderTotals() {
            // Remove existing badges
            document.querySelectorAll('.commander-total-badge').forEach(el => el.remove());

            for (let receiver = 0; receiver < gameState.playerCount; receiver++) {
                const receiverCard = document.getElementById(`player${receiver+1}Card`);
                if (!receiverCard) continue;

                // Build list of dealers who have dealt damage
                const damageList = [];
                
                // In 1P mode, check damage from virtual opponents (players 2-4)
                const maxDealers = gameState.playerCount === 1 ? 4 : gameState.playerCount;
                
                for (let dealer = 0; dealer < maxDealers; dealer++) {
                    if (dealer !== receiver) {
                        const damage = gameState.commanderDamage[receiver][dealer] || 0;
                        if (damage > 0) {
                            damageList.push({ dealer, damage });
                        }
                    }
                }

                // Only show badges if there's damage
                if (damageList.length > 0) {
                    const badge = document.createElement('div');
                    badge.className = 'commander-total-badge';
                    
                    // Create individual items for each dealer
                    damageList.forEach(({ dealer, damage }) => {
                        const item = document.createElement('span');
                        item.className = 'commander-badge-item';
                        // Use player names for 1P mode
                        const dealerName = gameState.playerCount === 1 ? 
                            (gameState.playerNames[dealer] || `P${dealer+1}`) : 
                            `P${dealer+1}`;
                        item.textContent = `${dealerName}:${damage}`;
                        badge.appendChild(item);
                    });
                    
                    receiverCard.style.position = 'relative';
                    receiverCard.appendChild(badge);
                }
            }
        }

        // === COUNTER MANAGEMENT ===

        // Open counter modal
        function openCounterModal(playerIndex) {
            currentPlayerForCounter = playerIndex;
            selectedCounterType = null;
            document.getElementById('customCounterName').style.display = 'none';
            document.getElementById('customCounterName').value = '';
            document.querySelectorAll('.counter-type-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.getElementById('counterModal').classList.add('active');
        }

        // Select counter type
        function selectCounterType(type) {
            selectedCounterType = type;
            document.querySelectorAll('.counter-type-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            if (type === 'Custom') {
                document.getElementById('customCounterName').style.display = 'block';
            } else {
                document.getElementById('customCounterName').style.display = 'none';
            }
        }

        // Close counter modal
        function closeCounterModal() {
            document.getElementById('counterModal').classList.remove('active');
            currentPlayerForCounter = null;
            selectedCounterType = null;
        }

        // Confirm add counter
        function confirmAddCounter() {
            if (!selectedCounterType) {
                alert('Please select a counter type');
                return;
            }

            let counterName = selectedCounterType;
            if (selectedCounterType === 'Custom') {
                counterName = document.getElementById('customCounterName').value.trim();
                if (!counterName) {
                    alert('Please enter a custom counter name');
                    return;
                }
            }

            // Add counter to player
            const counterId = Date.now().toString();
            gameState.counters[currentPlayerForCounter].push({
                id: counterId,
                name: counterName,
                value: 0
            });

            renderPlayerCounters(currentPlayerForCounter);
            saveState();
            closeCounterModal();
        }

        // Change counter value
        function changeCounter(playerIndex, counterId, amount) {
            const counter = gameState.counters[playerIndex].find(c => c.id === counterId);
            if (counter) {
                counter.value = Math.max(0, counter.value + amount);
                renderPlayerCounters(playerIndex);
                saveState();
            }
        }

        // Remove counter
        function removeCounter(playerIndex, counterId) {
            gameState.counters[playerIndex] = gameState.counters[playerIndex].filter(c => c.id !== counterId);
            renderPlayerCounters(playerIndex);
            saveState();
        }

        // Render counters for a player
        function renderPlayerCounters(playerIndex) {
            const countersContainer = document.getElementById(`player${playerIndex+1}Counters`);
            if (!countersContainer) return;

            const counters = gameState.counters[playerIndex] || [];
            
            if (counters.length === 0) {
                countersContainer.innerHTML = '';
                return;
            }

            countersContainer.innerHTML = counters.map(counter => `
                <div class="counter-row">
                    <span class="counter-label">${counter.name}</span>
                    <button class="counter-btn" onclick="changeCounter(${playerIndex}, '${counter.id}', -1)">-</button>
                    <span class="counter-value">${counter.value}</span>
                    <button class="counter-btn" onclick="changeCounter(${playerIndex}, '${counter.id}', 1)">+</button>
                    <button class="counter-btn" onclick="removeCounter(${playerIndex}, '${counter.id}')" style="color: var(--accent-red);">Ã</button>
                </div>
            `).join('');
        }

        // Render all counters
        function renderAllCounters() {
            for (let i = 0; i < gameState.playerCount; i++) {
                renderPlayerCounters(i);
            }
        }

        // === DECK MANAGEMENT ===

        // Toggle color selection
        function toggleColor(color) {
            const colorElement = document.querySelector(`.color-option[data-color="${color}"]`);
            
            if (selectedColors.includes(color)) {
                selectedColors = selectedColors.filter(c => c !== color);
                colorElement.classList.remove('selected');
            } else {
                selectedColors.push(color);
                colorElement.classList.add('selected');
            }
        }

        // Add new deck
        function addDeck(event) {
            event.preventDefault();
            
            const name = document.getElementById('deckName').value.trim();
            const notes = document.getElementById('deckNotes').value.trim();
            
            if (!name) {
                alert('Please enter a deck name');
                return;
            }
            
            const decks = JSON.parse(localStorage.getItem('mtgDecks') || '[]');
            
            const newDeck = {
                id: Date.now().toString(),
                name: name,
                colors: [...selectedColors],
                notes: notes,
                gamesPlayed: 0,
                wins: 0,
                losses: 0,
                createdAt: new Date().toISOString()
            };
            
            decks.push(newDeck);
            localStorage.setItem('mtgDecks', JSON.stringify(decks));
            
            // Reset form
            document.getElementById('deckName').value = '';
            document.getElementById('deckNotes').value = '';
            selectedColors = [];
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            
            // Reload decks
            loadDecks();
            
            alert('Deck added successfully!');
        }

        // Load and display decks
        function loadDecks() {
            const decks = JSON.parse(localStorage.getItem('mtgDecks') || '[]');
            const decksList = document.getElementById('decksList');
            
            if (decks.length === 0) {
                decksList.innerHTML = '<div class="empty-state">No decks yet. Create your first deck below!</div>';
                return;
            }
            
            decksList.innerHTML = decks.map(deck => {
                const winRate = deck.gamesPlayed > 0 ? Math.round((deck.wins / deck.gamesPlayed) * 100) : 0;
                
                const colorDots = deck.colors.map(color => 
                    `<div class="deck-color-dot ${color}"></div>`
                ).join('');
                
                return `
                    <div class="deck-card">
                        <div class="deck-header">
                            <div class="deck-name">${deck.name}</div>
                            <div class="deck-colors">${colorDots || '<span style="color: var(--text-secondary); font-size: 0.9rem;">Colorless</span>'}</div>
                        </div>
                        ${deck.notes ? `<div style="color: var(--text-secondary); margin-bottom: 15px; font-style: italic;">${deck.notes}</div>` : ''}
                        <div class="deck-stats">
                            <div class="deck-stat">
                                <div class="deck-stat-label">Games</div>
                                <div class="deck-stat-value">${deck.gamesPlayed}</div>
                            </div>
                            <div class="deck-stat">
                                <div class="deck-stat-label">W/L</div>
                                <div class="deck-stat-value">${deck.wins}/${deck.losses}</div>
                            </div>
                            <div class="deck-stat">
                                <div class="deck-stat-label">Win Rate</div>
                                <div class="deck-stat-value">${winRate}%</div>
                            </div>
                        </div>
                        <div class="deck-actions">
                            <button class="deck-btn delete" onclick="deleteDeck('${deck.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Delete deck
        function deleteDeck(deckId) {
            if (!confirm('Are you sure you want to delete this deck? Game history will remain but won\'t be linked to this deck.')) {
                return;
            }
            
            let decks = JSON.parse(localStorage.getItem('mtgDecks') || '[]');
            decks = decks.filter(d => d.id !== deckId);
            localStorage.setItem('mtgDecks', JSON.stringify(decks));
            
            loadDecks();
        }

        // === VIEW SWITCHING ===

        document.getElementById('counterViewBtn').addEventListener('click', () => {
            document.getElementById('lifeCounterView').classList.remove('hidden');
            document.getElementById('decksView').classList.add('hidden');
            document.getElementById('statsView').classList.add('hidden');
            document.getElementById('counterViewBtn').classList.add('active');
            document.getElementById('decksViewBtn').classList.remove('active');
            document.getElementById('statsViewBtn').classList.remove('active');
        });

        document.getElementById('decksViewBtn').addEventListener('click', () => {
            document.getElementById('lifeCounterView').classList.add('hidden');
            document.getElementById('decksView').classList.remove('hidden');
            document.getElementById('statsView').classList.add('hidden');
            document.getElementById('counterViewBtn').classList.remove('active');
            document.getElementById('decksViewBtn').classList.add('active');
            document.getElementById('statsViewBtn').classList.remove('active');
            loadDecks();
        });

        document.getElementById('statsViewBtn').addEventListener('click', () => {
            document.getElementById('lifeCounterView').classList.add('hidden');
            document.getElementById('decksView').classList.add('hidden');
            document.getElementById('statsView').classList.remove('hidden');
            document.getElementById('statsViewBtn').classList.add('active');
            document.getElementById('counterViewBtn').classList.remove('active');
            document.getElementById('decksViewBtn').classList.remove('active');
            updateStats();
        });

        // Player count button handlers
        document.querySelectorAll('.player-count-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const count = parseInt(btn.getAttribute('data-count'));
                setPlayerCount(count);
            });
        });

        // Clear stats button handler
        document.getElementById('clearStatsBtn').addEventListener('click', clearAllStats);

        // Initialize app on load
        initApp();
    </script>
</body>
</html>
